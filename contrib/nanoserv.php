<code><span style="color: #000000">
<span style="color: #0000CC">&lt;?php<br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*<br />&nbsp;*&nbsp;nanoserv&nbsp;-&nbsp;a&nbsp;sockets&nbsp;daemon&nbsp;toolkit&nbsp;for&nbsp;PHP&nbsp;5.1+<br />&nbsp;*&nbsp;<br />&nbsp;*&nbsp;Copyright&nbsp;(C)&nbsp;2004-2009&nbsp;Vincent&nbsp;Negrier&nbsp;aka.&nbsp;sIX&nbsp;&lt;six&nbsp;at&nbsp;aegis-corp.org&gt;<br />&nbsp;*&nbsp;<br />&nbsp;*&nbsp;This&nbsp;library&nbsp;is&nbsp;free&nbsp;software;&nbsp;you&nbsp;can&nbsp;redistribute&nbsp;it&nbsp;and/or<br />&nbsp;*&nbsp;modify&nbsp;it&nbsp;under&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;GNU&nbsp;Lesser&nbsp;General&nbsp;Public<br />&nbsp;*&nbsp;License&nbsp;as&nbsp;published&nbsp;by&nbsp;the&nbsp;Free&nbsp;Software&nbsp;Foundation;&nbsp;either<br />&nbsp;*&nbsp;version&nbsp;2.1&nbsp;of&nbsp;the&nbsp;License,&nbsp;or&nbsp;(at&nbsp;your&nbsp;option)&nbsp;any&nbsp;later&nbsp;version.<br />&nbsp;*&nbsp;<br />&nbsp;*&nbsp;This&nbsp;library&nbsp;is&nbsp;distributed&nbsp;in&nbsp;the&nbsp;hope&nbsp;that&nbsp;it&nbsp;will&nbsp;be&nbsp;useful,<br />&nbsp;*&nbsp;but&nbsp;WITHOUT&nbsp;ANY&nbsp;WARRANTY;&nbsp;without&nbsp;even&nbsp;the&nbsp;implied&nbsp;warranty&nbsp;of<br />&nbsp;*&nbsp;MERCHANTABILITY&nbsp;or&nbsp;FITNESS&nbsp;FOR&nbsp;A&nbsp;PARTICULAR&nbsp;PURPOSE.&nbsp;&nbsp;See&nbsp;the&nbsp;GNU<br />&nbsp;*&nbsp;Lesser&nbsp;General&nbsp;Public&nbsp;License&nbsp;for&nbsp;more&nbsp;details.<br />&nbsp;*&nbsp;<br />&nbsp;*&nbsp;You&nbsp;should&nbsp;have&nbsp;received&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;GNU&nbsp;Lesser&nbsp;General&nbsp;Public<br />&nbsp;*&nbsp;License&nbsp;along&nbsp;with&nbsp;this&nbsp;library;&nbsp;if&nbsp;not,&nbsp;write&nbsp;to&nbsp;the&nbsp;Free&nbsp;Software<br />&nbsp;*&nbsp;Foundation,&nbsp;Inc.,&nbsp;59&nbsp;Temple&nbsp;Place,&nbsp;Suite&nbsp;330,&nbsp;Boston,&nbsp;MA&nbsp;&nbsp;02111-1307&nbsp;&nbsp;USA&nbsp;<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*/<br /><br />/**<br />&nbsp;*&nbsp;nanoserv&nbsp;current&nbsp;version&nbsp;number<br />&nbsp;*&nbsp;@var&nbsp;string<br />&nbsp;*/<br /></span><span style="color: #0000CC">define</span><span style="color: #006600">(</span><span style="color: #CC0000">"NS_VERSION"</span><span style="color: #006600">,&nbsp;</span><span style="color: #CC0000">"2.0.0-dev"</span><span style="color: #006600">);<br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*&nbsp;Base&nbsp;exception&nbsp;class<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*&nbsp;@since&nbsp;2.0<br />&nbsp;*/<br /></span><span style="color: #006600">class&nbsp;</span><span style="color: #0000CC">NS_Exception&nbsp;</span><span style="color: #006600">extends&nbsp;</span><span style="color: #0000CC">Exception&nbsp;</span><span style="color: #006600">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;</span><span style="color: #0000CC">$addr</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">$errmsg</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$errno</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$addr</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">parent</span><span style="color: #006600">::</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">$errmsg</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$errno</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">addr&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$addr</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*&nbsp;Server&nbsp;exception&nbsp;class<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*&nbsp;@since&nbsp;2.0<br />&nbsp;*/<br /></span><span style="color: #006600">class&nbsp;</span><span style="color: #0000CC">NS_Server_Exception&nbsp;</span><span style="color: #006600">extends&nbsp;</span><span style="color: #0000CC">NS_Exception&nbsp;</span><span style="color: #006600">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;</span><span style="color: #0000CC">$listener</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">$errmsg</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$errno</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$addr</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">NS_Listener&nbsp;$listener&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">NULL</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">parent</span><span style="color: #006600">::</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">$errmsg</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$errno</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$addr</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">listener&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$listener</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*&nbsp;Client&nbsp;exception&nbsp;class<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*&nbsp;@since&nbsp;2.0<br />&nbsp;*/<br /></span><span style="color: #006600">class&nbsp;</span><span style="color: #0000CC">NS_Client_Exception&nbsp;</span><span style="color: #006600">extends&nbsp;</span><span style="color: #0000CC">NS_Exception&nbsp;</span><span style="color: #006600">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">$errmsg</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$errno</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$addr</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">NS_Handler&nbsp;$handler&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">NULL</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">parent</span><span style="color: #006600">::</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">$errmsg</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$errno</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$addr</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">handler&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*&nbsp;Base&nbsp;socket&nbsp;class<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;*/<br /></span><span style="color: #006600">class&nbsp;</span><span style="color: #0000CC">NS_Socket&nbsp;</span><span style="color: #006600">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;bytes&nbsp;read&nbsp;by&nbsp;Read()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">const&nbsp;</span><span style="color: #0000CC">DEFAULT_READ_LENGTH&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">16384</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Internal&nbsp;Socket&nbsp;unique&nbsp;ID<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$id</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Socket&nbsp;stream&nbsp;descriptor<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;resource<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$fd</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Is&nbsp;the&nbsp;socket&nbsp;connected&nbsp;?<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$connected&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Is&nbsp;the&nbsp;socket&nbsp;waiting&nbsp;to&nbsp;be&nbsp;connected&nbsp;?<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$pending_connect&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Is&nbsp;the&nbsp;socket&nbsp;waiting&nbsp;for&nbsp;ssl/tls&nbsp;handshake&nbsp;?<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$pending_crypto&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Is&nbsp;the&nbsp;socket&nbsp;blocked&nbsp;?<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$blocked&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Stream&nbsp;context<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;resource<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">protected&nbsp;</span><span style="color: #0000CC">$context</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Crypto&nbsp;type<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$crypto_type</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Attached&nbsp;handler<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;NS_Connection_Handler<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Static&nbsp;instance&nbsp;counter<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">private&nbsp;static&nbsp;</span><span style="color: #0000CC">$sck_cnt</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;NS_Socket&nbsp;contructor<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;resource&nbsp;$fd<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">$fd&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$crypto_type</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$fd&nbsp;</span><span style="color: #006600">===&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">context&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">stream_context_create</span><span style="color: #006600">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$fd</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">connected&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Set_Blocking</span><span style="color: #006600">(</span><span style="color: #0000CC">false</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Set_Timeout</span><span style="color: #006600">(</span><span style="color: #0000CC">0</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$crypto_type&nbsp;</span><span style="color: #006600">!==&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">crypto_type&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$crypto_type</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">id&nbsp;</span><span style="color: #006600">=&nbsp;++</span><span style="color: #0000CC">NS_Socket</span><span style="color: #006600">::</span><span style="color: #0000CC">$sck_cnt</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;stream&nbsp;options<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Get_Options</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">stream_context_get_options</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">stream_context_get_options</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">context</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Set&nbsp;a&nbsp;stream&nbsp;context&nbsp;option<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$wrapper<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$opt<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mixed&nbsp;$val<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Set_Option</span><span style="color: #006600">(</span><span style="color: #0000CC">$wrapper</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$opt</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$val</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">stream_context_set_option</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$wrapper</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$opt</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$val</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">stream_context_set_option</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">context</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$wrapper</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$opt</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$val</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Set&nbsp;timeout<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$timeout<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">protected&nbsp;function&nbsp;</span><span style="color: #0000CC">Set_Timeout</span><span style="color: #006600">(</span><span style="color: #0000CC">$timeout</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">stream_set_timeout</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$timeout</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;wether&nbsp;the&nbsp;socket&nbsp;is&nbsp;blocking&nbsp;or&nbsp;not<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;bool&nbsp;$block<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">protected&nbsp;function&nbsp;</span><span style="color: #0000CC">Set_Blocking</span><span style="color: #006600">(</span><span style="color: #0000CC">$block</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">stream_set_blocking</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$block</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Set&nbsp;the&nbsp;stream&nbsp;write&nbsp;buffer&nbsp;(PHP&nbsp;defaults&nbsp;to&nbsp;8192&nbsp;bytes)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$buffer_size<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;2.0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">protected&nbsp;function&nbsp;</span><span style="color: #0000CC">Set_Write_Buffer</span><span style="color: #006600">(</span><span style="color: #0000CC">$buffer_size</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">stream_set_write_buffer</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$buffer_size</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Enable&nbsp;or&nbsp;disable&nbsp;ssl/tls&nbsp;crypto&nbsp;on&nbsp;the&nbsp;socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;bool&nbsp;$enable<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$type&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;mixed<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Enable_Crypto</span><span style="color: #006600">(</span><span style="color: #0000CC">$enable</span><span style="color: #006600">=</span><span style="color: #0000CC">true</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$type</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$type&nbsp;</span><span style="color: #006600">!==&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">crypto_type&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$type</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">//&nbsp;Workaround&nbsp;for&nbsp;http://bugs.php.net/bug.php?id=45808<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Set_Blocking</span><span style="color: #006600">(</span><span style="color: #0000CC">true</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Set_Timeout</span><span style="color: #006600">(</span><span style="color: #0000CC">1</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$ret&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">stream_socket_enable_crypto</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$enable</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">crypto_type</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">//&nbsp;Workaround&nbsp;for&nbsp;http://bugs.php.net/bug.php?id=45808<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Set_Blocking</span><span style="color: #006600">(</span><span style="color: #0000CC">false</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Set_Timeout</span><span style="color: #006600">(</span><span style="color: #0000CC">0</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">pending_crypto&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$ret&nbsp;</span><span style="color: #006600">===&nbsp;</span><span style="color: #0000CC">0</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$ret</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Setup&nbsp;crypto&nbsp;if&nbsp;needed<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Setup</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">crypto_type</span><span style="color: #006600">))&nbsp;return&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Enable_Crypto</span><span style="color: #006600">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;local&nbsp;socket&nbsp;name<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Get_Name</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">stream_socket_get_name</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;remote&nbsp;socket&nbsp;name<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Get_Peer_Name</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">stream_socket_get_name</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Read&nbsp;data&nbsp;from&nbsp;the&nbsp;socket&nbsp;and&nbsp;return&nbsp;it<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$length&nbsp;maximum&nbsp;read&nbsp;length<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Read</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">fread</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">DEFAULT_READ_LENGTH</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Read&nbsp;data&nbsp;from&nbsp;a&nbsp;non&nbsp;connected&nbsp;socket&nbsp;and&nbsp;return&nbsp;it<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;&amp;$addr&nbsp;contains&nbsp;the&nbsp;message&nbsp;sender&nbsp;address&nbsp;upon&nbsp;return<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$length&nbsp;maximum&nbsp;read&nbsp;length<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9.61<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Read_From</span><span style="color: #006600">(&amp;</span><span style="color: #0000CC">$addr</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$length</span><span style="color: #006600">=</span><span style="color: #0000CC">16384</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">stream_socket_recvfrom</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$length</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">NULL</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$addr</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Write&nbsp;data&nbsp;to&nbsp;the&nbsp;socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;write&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;to&nbsp;the&nbsp;socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$data<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Write</span><span style="color: #006600">(</span><span style="color: #0000CC">$data</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$nb&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">fwrite</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$data</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$nb&nbsp;</span><span style="color: #006600">!=&nbsp;</span><span style="color: #0000CC">strlen</span><span style="color: #006600">(</span><span style="color: #0000CC">$data</span><span style="color: #006600">))&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">blocked&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$nb</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Write&nbsp;data&nbsp;to&nbsp;a&nbsp;non&nbsp;connected&nbsp;socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$to&nbsp;in&nbsp;the&nbsp;form&nbsp;of&nbsp;"&lt;ip_address&gt;:&lt;port&gt;"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$data<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9.61<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Write_To</span><span style="color: #006600">(</span><span style="color: #0000CC">$to</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$data</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">stream_socket_sendto</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$data</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">NULL</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$to</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Query&nbsp;end&nbsp;of&nbsp;stream&nbsp;status<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Eof</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #0000CC">is_resource</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">))&nbsp;return&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">stream_socket_recvfrom</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">1</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">STREAM_PEEK</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(</span><span style="color: #0000CC">feof</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Close&nbsp;the&nbsp;socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Close</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">connected</span><span style="color: #006600">)&nbsp;</span><span style="color: #0000CC">fclose</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">connected&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">pending_connect&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;NS_Socket&nbsp;destructor<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">__destruct</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">Nanoserv</span><span style="color: #006600">::</span><span style="color: #0000CC">Free_Write_Buffers</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">id</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Close</span><span style="color: #006600">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*&nbsp;Server&nbsp;socket&nbsp;class<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;*/<br /></span><span style="color: #006600">class&nbsp;</span><span style="color: #0000CC">NS_Server_Socket&nbsp;</span><span style="color: #006600">extends&nbsp;</span><span style="color: #0000CC">NS_Socket&nbsp;</span><span style="color: #006600">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Listen&nbsp;address&nbsp;(format&nbsp;is&nbsp;'proto://addr:port')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$address</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Real&nbsp;listen&nbsp;address&nbsp;(format&nbsp;is&nbsp;'proto://addr:port')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">private&nbsp;</span><span style="color: #0000CC">$real_address</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;NS_Socket_Server&nbsp;constructor<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">parent</span><span style="color: #006600">::</span><span style="color: #0000CC">__construct</span><span style="color: #006600">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">address&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$addr</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$proto&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">strtolower</span><span style="color: #006600">(</span><span style="color: #0000CC">strtok</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">,&nbsp;</span><span style="color: #CC0000">":"</span><span style="color: #006600">));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$s&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">strtok</span><span style="color: #006600">(</span><span style="color: #CC0000">""</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$proto&nbsp;</span><span style="color: #006600">==&nbsp;</span><span style="color: #CC0000">"udp"</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">real_address&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$addr</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">real_address&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #CC0000">"tcp:"&nbsp;</span><span style="color: #006600">.&nbsp;</span><span style="color: #0000CC">$s</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$proto&nbsp;</span><span style="color: #006600">!=&nbsp;</span><span style="color: #CC0000">"tcp"</span><span style="color: #006600">)&nbsp;switch&nbsp;(</span><span style="color: #0000CC">$proto</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #CC0000">"ssl"</span><span style="color: #006600">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">crypto_type&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">STREAM_CRYPTO_METHOD_SSLv23_SERVER</span><span style="color: #006600">;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #CC0000">"tls"</span><span style="color: #006600">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">crypto_type&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">STREAM_CRYPTO_METHOD_TLS_SERVER</span><span style="color: #006600">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #CC0000">"sslv2"</span><span style="color: #006600">:&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">crypto_type&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">STREAM_CRYPTO_METHOD_SSLv2_SERVER</span><span style="color: #006600">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #CC0000">"sslv3"</span><span style="color: #006600">:&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">crypto_type&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">STREAM_CRYPTO_METHOD_SSLv3_SERVER</span><span style="color: #006600">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">defined</span><span style="color: #006600">(</span><span style="color: #0000CC">$cname&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #CC0000">"STREAM_CRYPTO_METHOD_"</span><span style="color: #006600">.</span><span style="color: #0000CC">strtoupper</span><span style="color: #006600">(</span><span style="color: #0000CC">$proto</span><span style="color: #006600">).</span><span style="color: #CC0000">"_SERVER"</span><span style="color: #006600">))&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">crypto_type&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">constant</span><span style="color: #006600">(</span><span style="color: #0000CC">$cname</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Start&nbsp;listening&nbsp;and&nbsp;accepting&nbsp;connetions<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Listen</span><span style="color: #006600">(</span><span style="color: #0000CC">$bind_only</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$errno&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$errstr&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">stream_socket_server</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">real_address</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$errno</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$errstr</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">STREAM_SERVER_BIND&nbsp;</span><span style="color: #006600">|&nbsp;(</span><span style="color: #0000CC">$bind_only&nbsp;</span><span style="color: #006600">?&nbsp;</span><span style="color: #0000CC">0&nbsp;</span><span style="color: #006600">:&nbsp;</span><span style="color: #0000CC">STREAM_SERVER_LISTEN</span><span style="color: #006600">),&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">context</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd&nbsp;</span><span style="color: #006600">===&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000CC">NS_Server_Exception</span><span style="color: #006600">(</span><span style="color: #CC0000">"cannot&nbsp;listen&nbsp;to&nbsp;{$this-&gt;real_address}:&nbsp;{$errstr}"</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$errno</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">real_address</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Set_Blocking</span><span style="color: #006600">(</span><span style="color: #0000CC">false</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Set_Timeout</span><span style="color: #006600">(</span><span style="color: #0000CC">0</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Accept&nbsp;connection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;resource<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Accept</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;@</span><span style="color: #0000CC">stream_socket_accept</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">0</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /><br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*&nbsp;Client&nbsp;socket&nbsp;class<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;*/<br /></span><span style="color: #006600">class&nbsp;</span><span style="color: #0000CC">NS_Client_Socket&nbsp;</span><span style="color: #006600">extends&nbsp;</span><span style="color: #0000CC">NS_Socket&nbsp;</span><span style="color: #006600">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Connect&nbsp;timeout&nbsp;(seconds)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">const&nbsp;</span><span style="color: #0000CC">CONNECT_TIMEOUT&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">10</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Peer&nbsp;address&nbsp;(format&nbsp;is&nbsp;'proto://addr:port')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$address</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Connect&nbsp;timeout&nbsp;(timestamp)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$connect_timeout</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;NS_Socket_Client&nbsp;constructor<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">parent</span><span style="color: #006600">::</span><span style="color: #0000CC">__construct</span><span style="color: #006600">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">address&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$addr</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$proto&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">strtolower</span><span style="color: #006600">(</span><span style="color: #0000CC">strtok</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">,&nbsp;</span><span style="color: #CC0000">":"</span><span style="color: #006600">));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$s&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">strtok</span><span style="color: #006600">(</span><span style="color: #CC0000">""</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$proto&nbsp;</span><span style="color: #006600">==&nbsp;</span><span style="color: #CC0000">"udp"</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">real_address&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$addr</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">real_address&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #CC0000">"tcp:"&nbsp;</span><span style="color: #006600">.&nbsp;</span><span style="color: #0000CC">$s</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$proto&nbsp;</span><span style="color: #006600">!=&nbsp;</span><span style="color: #CC0000">"tcp"</span><span style="color: #006600">)&nbsp;switch&nbsp;(</span><span style="color: #0000CC">$proto</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #CC0000">"ssl"</span><span style="color: #006600">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">crypto_type&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">STREAM_CRYPTO_METHOD_SSLv23_CLIENT</span><span style="color: #006600">;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #CC0000">"tls"</span><span style="color: #006600">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">crypto_type&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">STREAM_CRYPTO_METHOD_TLS_CLIENT</span><span style="color: #006600">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #CC0000">"sslv2"</span><span style="color: #006600">:&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">crypto_type&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">STREAM_CRYPTO_METHOD_SSLv2_CLIENT</span><span style="color: #006600">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #CC0000">"sslv3"</span><span style="color: #006600">:&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">crypto_type&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">STREAM_CRYPTO_METHOD_SSLv3_CLIENT</span><span style="color: #006600">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">defined</span><span style="color: #006600">(</span><span style="color: #0000CC">$cname&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #CC0000">"STREAM_CRYPTO_METHOD_"</span><span style="color: #006600">.</span><span style="color: #0000CC">strtoupper</span><span style="color: #006600">(</span><span style="color: #0000CC">$proto</span><span style="color: #006600">).</span><span style="color: #CC0000">"_CLIENT"</span><span style="color: #006600">))&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">crypto_type&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">constant</span><span style="color: #006600">(</span><span style="color: #0000CC">$cname</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Connect&nbsp;to&nbsp;the&nbsp;peer&nbsp;address<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$timeout&nbsp;connection&nbsp;timeout&nbsp;in&nbsp;seconds<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Connect</span><span style="color: #006600">(</span><span style="color: #0000CC">$timeout</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$errno&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$errstr&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">stream_socket_client</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">real_address</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$errno</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$errstr</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">3</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">STREAM_CLIENT_ASYNC_CONNECT&nbsp;</span><span style="color: #006600">|&nbsp;</span><span style="color: #0000CC">STREAM_CLIENT_CONNECT</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">context</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd&nbsp;</span><span style="color: #006600">===&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000CC">NS_Client_Exception</span><span style="color: #006600">(</span><span style="color: #CC0000">"cannot&nbsp;connect&nbsp;to&nbsp;{$this-&gt;real_address}:&nbsp;{$errstr}"</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$errno</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">real_address</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$timeout&nbsp;</span><span style="color: #006600">===&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;</span><span style="color: #0000CC">$timeout&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">CONNECT_TIMEOUT</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">connect_timeout&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">time</span><span style="color: #006600">()&nbsp;+&nbsp;</span><span style="color: #0000CC">$timeout</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">pending_connect&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">connected&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Set_Blocking</span><span style="color: #006600">(</span><span style="color: #0000CC">false</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Set_Timeout</span><span style="color: #006600">(</span><span style="color: #0000CC">0</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /><br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*&nbsp;IPC&nbsp;Socket&nbsp;class<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;*/<br /></span><span style="color: #006600">class&nbsp;</span><span style="color: #0000CC">NS_IPC_Socket&nbsp;</span><span style="color: #006600">extends&nbsp;</span><span style="color: #0000CC">NS_Socket&nbsp;</span><span style="color: #006600">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Maximum&nbsp;size&nbsp;of&nbsp;inter&nbsp;process&nbsp;communication&nbsp;packets<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">const&nbsp;</span><span style="color: #0000CC">IPC_MAX_PACKET_SIZE&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">1048576</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;pid&nbsp;number&nbsp;of&nbsp;the&nbsp;remote&nbsp;forked&nbsp;process<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$pid</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;IPC&nbsp;Socket&nbsp;constructor<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;resource&nbsp;$fd<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$pid<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">$fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$pid</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">parent</span><span style="color: #006600">::</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">$fd</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Set_Write_Buffer</span><span style="color: #006600">(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">IPC_MAX_PACKET_SIZE</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">pid&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$pid</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Read&nbsp;data&nbsp;from&nbsp;IPC&nbsp;socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Read</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">fread</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">IPC_MAX_PACKET_SIZE</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Creates&nbsp;a&nbsp;pair&nbsp;of&nbsp;connected,&nbsp;indistinguishable&nbsp;pipes<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;an&nbsp;array&nbsp;of&nbsp;two&nbsp;NS_Socket&nbsp;objects<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$domain<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$type<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$proto<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">Pair</span><span style="color: #006600">(</span><span style="color: #0000CC">$domain</span><span style="color: #006600">=</span><span style="color: #0000CC">STREAM_PF_UNIX</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$type</span><span style="color: #006600">=</span><span style="color: #0000CC">STREAM_SOCK_DGRAM</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$proto</span><span style="color: #006600">=</span><span style="color: #0000CC">0</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list(</span><span style="color: #0000CC">$s1</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$s2</span><span style="color: #006600">)&nbsp;=&nbsp;</span><span style="color: #0000CC">stream_socket_pair</span><span style="color: #006600">(</span><span style="color: #0000CC">$domain</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$type</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$proto</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array(new&nbsp;</span><span style="color: #0000CC">NS_IPC_Socket</span><span style="color: #006600">(</span><span style="color: #0000CC">$s1</span><span style="color: #006600">),&nbsp;new&nbsp;</span><span style="color: #0000CC">NS_IPC_Socket</span><span style="color: #006600">(</span><span style="color: #0000CC">$s2</span><span style="color: #006600">));<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Ask&nbsp;the&nbsp;master&nbsp;process&nbsp;for&nbsp;object&nbsp;data<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;array&nbsp;$request<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;bool&nbsp;$need_response<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;mixed<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Ask_Master</span><span style="color: #006600">(</span><span style="color: #0000CC">$request</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$need_response</span><span style="color: #006600">=</span><span style="color: #0000CC">true</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Write</span><span style="color: #006600">(</span><span style="color: #0000CC">serialize</span><span style="color: #006600">(</span><span style="color: #0000CC">$request</span><span style="color: #006600">));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #0000CC">$need_response</span><span style="color: #006600">)&nbsp;return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$rfd&nbsp;</span><span style="color: #006600">=&nbsp;array(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$dfd&nbsp;</span><span style="color: #006600">=&nbsp;array();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(@</span><span style="color: #0000CC">stream_select</span><span style="color: #006600">(</span><span style="color: #0000CC">$rfd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$dfd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$dfd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">600</span><span style="color: #006600">))&nbsp;return&nbsp;</span><span style="color: #0000CC">unserialize</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Read</span><span style="color: #006600">());<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*&nbsp;Timer&nbsp;class<br />&nbsp;*<br />&nbsp;*&nbsp;Do&nbsp;not&nbsp;instanciate&nbsp;NS_Timer&nbsp;but&nbsp;use&nbsp;the&nbsp;Nanoserv::New_Timer()&nbsp;method&nbsp;instead<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;*/<br /></span><span style="color: #006600">class&nbsp;</span><span style="color: #0000CC">NS_Timer&nbsp;</span><span style="color: #006600">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;System&nbsp;time<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$time</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Timer&nbsp;callback<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;mixed<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$callback</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Timer&nbsp;status<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$active&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;NS_Timer&nbsp;constructor<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$time<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mixed&nbsp;$callback<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;Nanoserv::New_Timer()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">$time</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$callback</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">time&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$time</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">callback&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$callback</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Activate&nbsp;timer<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Timers&nbsp;are&nbsp;activated&nbsp;by&nbsp;default,&nbsp;and&nbsp;Activate&nbsp;should&nbsp;only&nbsp;be&nbsp;used&nbsp;after&nbsp;a&nbsp;call&nbsp;do&nbsp;Deactivate()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;NS_Timer::Deactivate()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Activate</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">active&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Deactivate&nbsp;timer<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Deactivate</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">active&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /><br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*&nbsp;Write&nbsp;buffer&nbsp;class<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;*/<br /></span><span style="color: #006600">class&nbsp;</span><span style="color: #0000CC">NS_Write_Buffer&nbsp;</span><span style="color: #006600">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Attached&nbsp;socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;NS_Socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$socket</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Buffered&nbsp;data<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">private&nbsp;</span><span style="color: #0000CC">$data</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Buffered&nbsp;data&nbsp;pointer<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">private&nbsp;</span><span style="color: #0000CC">$pointer&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">0</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Data&nbsp;length&nbsp;in&nbsp;bytes<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">private&nbsp;</span><span style="color: #0000CC">$length</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;End-of-write&nbsp;Callback<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;mixed<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">private&nbsp;</span><span style="color: #0000CC">$callback&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;NS_Write_Buffer&nbsp;constructor<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;NS_Socket&nbsp;$socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$data<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mixed&nbsp;$callback<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">NS_Socket&nbsp;$socket</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$data</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$callback</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$socket</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">data&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$data</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">length&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">strlen</span><span style="color: #006600">(</span><span style="color: #0000CC">$data</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">callback&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$callback</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Fetch&nbsp;data&nbsp;from&nbsp;the&nbsp;internal&nbsp;buffer<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$length<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Fetch_Data</span><span style="color: #006600">(</span><span style="color: #0000CC">$length</span><span style="color: #006600">=</span><span style="color: #0000CC">16384</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$s&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">substr</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">data</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">pointer</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$length</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$s</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;availability&nbsp;of&nbsp;data<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Waiting_Data</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">pointer&nbsp;</span><span style="color: #006600">&lt;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">length</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Write&nbsp;data&nbsp;to&nbsp;socket&nbsp;and&nbsp;advance&nbsp;buffer&nbsp;pointer<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$length<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Write</span><span style="color: #006600">(</span><span style="color: #0000CC">$length</span><span style="color: #006600">=</span><span style="color: #0000CC">16384</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">pointer&nbsp;</span><span style="color: #006600">+=&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Write</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Fetch_Data</span><span style="color: #006600">(</span><span style="color: #0000CC">$length</span><span style="color: #006600">));<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;NS_Write_Buffer&nbsp;destructor<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">__destruct</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">callback&nbsp;</span><span style="color: #006600">!==&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;</span><span style="color: #0000CC">call_user_func</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">callback</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Waiting_Data</span><span style="color: #006600">());<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /><br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*&nbsp;Base&nbsp;handler&nbsp;class<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;*/<br /></span><span style="color: #006600">abstract&nbsp;class&nbsp;</span><span style="color: #0000CC">NS_Handler&nbsp;</span><span style="color: #006600">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Attached&nbsp;socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;NS_Socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$socket</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Set&nbsp;a&nbsp;stream&nbsp;context&nbsp;option<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$wrapper<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$opt<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mixed&nbsp;$val<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Set_Option</span><span style="color: #006600">(</span><span style="color: #0000CC">$wrapper</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$opt</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$val</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Set_Option</span><span style="color: #006600">(</span><span style="color: #0000CC">$wrapper</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$opt</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$val</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /><br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*&nbsp;Datagram&nbsp;listener&nbsp;/&nbsp;handler&nbsp;class<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*&nbsp;@since&nbsp;0.9.61<br />&nbsp;*/<br /></span><span style="color: #006600">abstract&nbsp;class&nbsp;</span><span style="color: #0000CC">NS_Datagram_Handler&nbsp;</span><span style="color: #006600">extends&nbsp;</span><span style="color: #0000CC">NS_Handler&nbsp;</span><span style="color: #006600">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Is&nbsp;the&nbsp;listener&nbsp;active&nbsp;?<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$active&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;NS_Datagram_Handler&nbsp;constructor<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$addr<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$handler_classname<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mixed&nbsp;$handler_options<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket&nbsp;</span><span style="color: #006600">=&nbsp;new&nbsp;</span><span style="color: #0000CC">NS_Server_Socket</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Activate&nbsp;the&nbsp;listener<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9.61<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Activate</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$ret&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Listen</span><span style="color: #006600">(</span><span style="color: #0000CC">true</span><span style="color: #006600">))&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">active&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$ret</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(</span><span style="color: #0000CC">NS_Server_Exception&nbsp;$e</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000CC">NS_Server_Exception</span><span style="color: #006600">(</span><span style="color: #0000CC">$e</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">getMessage</span><span style="color: #006600">(),&nbsp;</span><span style="color: #0000CC">$e</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">getCode</span><span style="color: #006600">(),&nbsp;</span><span style="color: #0000CC">$e</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">addr</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Deactivate&nbsp;the&nbsp;listener<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9.61<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Deactivate</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Close</span><span style="color: #006600">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">active&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Send&nbsp;data&nbsp;over&nbsp;the&nbsp;connection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$to&nbsp;in&nbsp;the&nbsp;form&nbsp;of&nbsp;"&lt;ip_address&gt;:&lt;port&gt;"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$data<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9.61<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Write</span><span style="color: #006600">(</span><span style="color: #0000CC">$to</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$data</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Write_To</span><span style="color: #006600">(</span><span style="color: #0000CC">$to</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$data</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Event&nbsp;called&nbsp;on&nbsp;data&nbsp;reception<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$from<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$data<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9.61<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">on_Read</span><span style="color: #006600">(</span><span style="color: #0000CC">$from</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$data</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;NS_Datagram_Handler&nbsp;destructor<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">__destruct</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Deactivate</span><span style="color: #006600">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />}<br /><br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*&nbsp;Connection&nbsp;handler&nbsp;class<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;*/<br /></span><span style="color: #006600">abstract&nbsp;class&nbsp;</span><span style="color: #0000CC">NS_Connection_Handler&nbsp;</span><span style="color: #006600">extends&nbsp;</span><span style="color: #0000CC">NS_Handler&nbsp;</span><span style="color: #006600">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**#@+<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Cause&nbsp;of&nbsp;connection&nbsp;failure<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">const&nbsp;</span><span style="color: #0000CC">FAIL_NORESPONSE&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">1</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;</span><span style="color: #0000CC">FAIL_TIMEOUT&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">2</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**#@-*/<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Send&nbsp;data&nbsp;over&nbsp;the&nbsp;connection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$data<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mixed&nbsp;$callback<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;NS_Write_Buffer<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Write</span><span style="color: #006600">(</span><span style="color: #0000CC">$data</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$callback</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">Nanoserv</span><span style="color: #006600">::</span><span style="color: #0000CC">New_Write_Buffer</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$data</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$callback</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Connect<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$timeout&nbsp;timeout&nbsp;in&nbsp;seconds<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Connect</span><span style="color: #006600">(</span><span style="color: #0000CC">$timeout</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Connect</span><span style="color: #006600">(</span><span style="color: #0000CC">$timeout</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(</span><span style="color: #0000CC">NS_Client_Exception&nbsp;$e</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000CC">NS_Client_Exception</span><span style="color: #006600">(</span><span style="color: #0000CC">$e</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">getMessage</span><span style="color: #006600">(),&nbsp;</span><span style="color: #0000CC">$e</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">getCode</span><span style="color: #006600">(),&nbsp;</span><span style="color: #0000CC">$e</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">addr</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Disconnect<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Disconnect</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Close</span><span style="color: #006600">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">Nanoserv</span><span style="color: #006600">::</span><span style="color: #0000CC">Free_Connection</span><span style="color: #006600">(</span><span style="color: #0000CC">$this</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Event&nbsp;called&nbsp;on&nbsp;received&nbsp;connection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">on_Accept</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Event&nbsp;called&nbsp;on&nbsp;established&nbsp;connection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">on_Connect</span><span style="color: #006600">()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Event&nbsp;called&nbsp;on&nbsp;failed&nbsp;connection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$failcode&nbsp;see&nbsp;NS_Connection_Handler::FAIL_*&nbsp;constants<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">on_Connect_Fail</span><span style="color: #006600">(</span><span style="color: #0000CC">$failcode</span><span style="color: #006600">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Event&nbsp;called&nbsp;on&nbsp;disconnection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">on_Disconnect</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Event&nbsp;called&nbsp;on&nbsp;data&nbsp;reception<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$data<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">on_Read</span><span style="color: #006600">(</span><span style="color: #0000CC">$data</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Event&nbsp;called&nbsp;before&nbsp;forking<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;2.0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">on_Fork_Prepare</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Event&nbsp;called&nbsp;after&nbsp;forking,&nbsp;both&nbsp;on&nbsp;master&nbsp;and&nbsp;child&nbsp;processes<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;2.0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">on_Fork_Done</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /><br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*&nbsp;Listener&nbsp;class<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;*/<br /></span><span style="color: #006600">class&nbsp;</span><span style="color: #0000CC">NS_Listener&nbsp;</span><span style="color: #006600">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Attached&nbsp;socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;NS_Server_Socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$socket</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Name&nbsp;of&nbsp;the&nbsp;handler&nbsp;class<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;NS_Connetion_Handler<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$handler_classname</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Handler&nbsp;options<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;this&nbsp;is&nbsp;passed&nbsp;as&nbsp;the&nbsp;first&nbsp;constructor&nbsp;parameter&nbsp;of&nbsp;each&nbsp;spawned&nbsp;connection&nbsp;handlers<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;mixed<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$handler_options</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Is&nbsp;the&nbsp;listener&nbsp;active&nbsp;?<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$active&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;set&nbsp;the&nbsp;listener&nbsp;will&nbsp;fork()&nbsp;a&nbsp;new&nbsp;process&nbsp;for&nbsp;each&nbsp;accepted&nbsp;connection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$forking&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;NS_Listener&nbsp;constructor<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$addr<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$handler_classname<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mixed&nbsp;$handler_options<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$handler_classname</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$handler_options</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$forking</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket&nbsp;</span><span style="color: #006600">=&nbsp;new&nbsp;</span><span style="color: #0000CC">NS_Server_Socket</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">handler_classname&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$handler_classname</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">handler_options&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$handler_options</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">forking&nbsp;</span><span style="color: #006600">=&nbsp;(</span><span style="color: #0000CC">$forking&nbsp;</span><span style="color: #006600">&amp;&amp;&nbsp;</span><span style="color: #0000CC">is_callable</span><span style="color: #006600">(</span><span style="color: #CC0000">"pcntl_fork"</span><span style="color: #006600">));<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Set&nbsp;a&nbsp;stream&nbsp;context&nbsp;option<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$wrapper<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$opt<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mixed&nbsp;$val<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Set_Option</span><span style="color: #006600">(</span><span style="color: #0000CC">$wrapper</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$opt</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$val</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Set_Option</span><span style="color: #006600">(</span><span style="color: #0000CC">$wrapper</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$opt</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$val</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;wether&nbsp;the&nbsp;listener&nbsp;should&nbsp;fork()&nbsp;a&nbsp;new&nbsp;process&nbsp;for&nbsp;each&nbsp;accepted&nbsp;connection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;bool&nbsp;$forking<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Set_Forking</span><span style="color: #006600">(</span><span style="color: #0000CC">$forking</span><span style="color: #006600">=</span><span style="color: #0000CC">true</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$forking&nbsp;</span><span style="color: #006600">&amp;&amp;&nbsp;!</span><span style="color: #0000CC">is_callable</span><span style="color: #006600">(</span><span style="color: #CC0000">"pcntl_fork"</span><span style="color: #006600">))&nbsp;return&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">forking&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$forking</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Activate&nbsp;the&nbsp;listener<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Activate</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$ret&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Listen</span><span style="color: #006600">())&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">active&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$ret</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(</span><span style="color: #0000CC">NS_Server_Exception&nbsp;$e</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000CC">NS_Server_Exception</span><span style="color: #006600">(</span><span style="color: #0000CC">$e</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">getMessage</span><span style="color: #006600">(),&nbsp;</span><span style="color: #0000CC">$e</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">getCode</span><span style="color: #006600">(),&nbsp;</span><span style="color: #0000CC">$e</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">addr</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Deactivate&nbsp;the&nbsp;listener<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">Deactivate</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Close</span><span style="color: #006600">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">active&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;NS_Listener&nbsp;destructor<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">__destruct</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Deactivate</span><span style="color: #006600">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /><br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*&nbsp;Shared&nbsp;object&nbsp;class&nbsp;for&nbsp;inter-process&nbsp;communications<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;*/<br /></span><span style="color: #006600">class&nbsp;</span><span style="color: #0000CC">NS_Shared_Object&nbsp;</span><span style="color: #006600">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;caller&nbsp;process&nbsp;pid<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;</span><span style="color: #0000CC">$caller_pid</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;shared&nbsp;object&nbsp;unique&nbsp;identifier<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;</span><span style="color: #0000CC">$_oid</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;wrapped&nbsp;object<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;object<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">private&nbsp;</span><span style="color: #0000CC">$wrapped</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;static&nbsp;instance&nbsp;counter<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;</span><span style="color: #0000CC">$shared_count&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">0</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;NS_Shared_Object&nbsp;constructor<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;$o&nbsp;is&nbsp;omited,&nbsp;a&nbsp;new&nbsp;StdClass&nbsp;object&nbsp;will&nbsp;be&nbsp;created&nbsp;and&nbsp;wrapped<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;object&nbsp;$o<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">public&nbsp;function&nbsp;</span><span style="color: #0000CC">__construct</span><span style="color: #006600">(</span><span style="color: #0000CC">$o</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$o&nbsp;</span><span style="color: #006600">===&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;</span><span style="color: #0000CC">$o&nbsp;</span><span style="color: #006600">=&nbsp;new&nbsp;</span><span style="color: #0000CC">StdClass</span><span style="color: #006600">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">_oid&nbsp;</span><span style="color: #006600">=&nbsp;++</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$shared_count</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">wrapped&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$o</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">__get</span><span style="color: #006600">(</span><span style="color: #0000CC">$k</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">Nanoserv</span><span style="color: #006600">::</span><span style="color: #0000CC">$child_process</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">Nanoserv</span><span style="color: #006600">::</span><span style="color: #0000CC">$master_pipe</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Ask_Master</span><span style="color: #006600">(array(</span><span style="color: #CC0000">"oid"&nbsp;</span><span style="color: #006600">=&gt;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">_oid</span><span style="color: #006600">,&nbsp;</span><span style="color: #CC0000">"action"&nbsp;</span><span style="color: #006600">=&gt;&nbsp;</span><span style="color: #CC0000">"G"</span><span style="color: #006600">,&nbsp;</span><span style="color: #CC0000">"var"&nbsp;</span><span style="color: #006600">=&gt;&nbsp;</span><span style="color: #0000CC">$k</span><span style="color: #006600">));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">wrapped</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">$k</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">__set</span><span style="color: #006600">(</span><span style="color: #0000CC">$k</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$v</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">Nanoserv</span><span style="color: #006600">::</span><span style="color: #0000CC">$child_process</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">Nanoserv</span><span style="color: #006600">::</span><span style="color: #0000CC">$master_pipe</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Ask_Master</span><span style="color: #006600">(array(</span><span style="color: #CC0000">"oid"&nbsp;</span><span style="color: #006600">=&gt;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">_oid</span><span style="color: #006600">,&nbsp;</span><span style="color: #CC0000">"action"&nbsp;</span><span style="color: #006600">=&gt;&nbsp;</span><span style="color: #CC0000">"S"</span><span style="color: #006600">,&nbsp;</span><span style="color: #CC0000">"var"&nbsp;</span><span style="color: #006600">=&gt;&nbsp;</span><span style="color: #0000CC">$k</span><span style="color: #006600">,&nbsp;</span><span style="color: #CC0000">"val"&nbsp;</span><span style="color: #006600">=&gt;&nbsp;</span><span style="color: #0000CC">$v</span><span style="color: #006600">),&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">wrapped</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">$k&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$v</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">__call</span><span style="color: #006600">(</span><span style="color: #0000CC">$m</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$a</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">Nanoserv</span><span style="color: #006600">::</span><span style="color: #0000CC">$child_process</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">Nanoserv</span><span style="color: #006600">::</span><span style="color: #0000CC">$master_pipe</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Ask_Master</span><span style="color: #006600">(array(</span><span style="color: #CC0000">"oid"&nbsp;</span><span style="color: #006600">=&gt;&nbsp;</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">_oid</span><span style="color: #006600">,&nbsp;</span><span style="color: #CC0000">"action"&nbsp;</span><span style="color: #006600">=&gt;&nbsp;</span><span style="color: #CC0000">"C"</span><span style="color: #006600">,&nbsp;</span><span style="color: #CC0000">"func"&nbsp;</span><span style="color: #006600">=&gt;&nbsp;</span><span style="color: #0000CC">$m</span><span style="color: #006600">,&nbsp;</span><span style="color: #CC0000">"args"&nbsp;</span><span style="color: #006600">=&gt;&nbsp;</span><span style="color: #0000CC">$a</span><span style="color: #006600">));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">call_user_func_array</span><span style="color: #006600">(array(</span><span style="color: #0000CC">$this</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">wrapped</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$m</span><span style="color: #006600">),&nbsp;</span><span style="color: #0000CC">$a</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /><br /><br /></span><span style="color: #FF9900">/**<br />&nbsp;*&nbsp;Server&nbsp;/&nbsp;multiplexer&nbsp;class<br />&nbsp;*<br />&nbsp;*&nbsp;@package&nbsp;nanoserv<br />&nbsp;*&nbsp;@subpackage&nbsp;Core<br />&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;*/<br /></span><span style="color: #006600">final&nbsp;class&nbsp;</span><span style="color: #0000CC">Nanoserv&nbsp;</span><span style="color: #006600">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;nanoserv&nbsp;current&nbsp;version&nbsp;number<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">const&nbsp;</span><span style="color: #0000CC">VERSION&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">NS_VERSION</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Registered&nbsp;listeners<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;array<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;private&nbsp;</span><span style="color: #0000CC">$listeners&nbsp;</span><span style="color: #006600">=&nbsp;array();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Write&nbsp;buffers<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;array<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;private&nbsp;</span><span style="color: #0000CC">$write_buffers&nbsp;</span><span style="color: #006600">=&nbsp;array();<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Active&nbsp;connections<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;array<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;private&nbsp;</span><span style="color: #0000CC">$connections&nbsp;</span><span style="color: #006600">=&nbsp;array();<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Active&nbsp;datagram&nbsp;handlers<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;array<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;private&nbsp;</span><span style="color: #0000CC">$dgram_handlers&nbsp;</span><span style="color: #006600">=&nbsp;array();<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Shared&nbsp;objects<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;array<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;private&nbsp;</span><span style="color: #0000CC">$shared_objects&nbsp;</span><span style="color: #006600">=&nbsp;array();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Forked&nbsp;process&nbsp;pipes<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;array<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;private&nbsp;</span><span style="color: #0000CC">$forked_pipes&nbsp;</span><span style="color: #006600">=&nbsp;array();<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Timers<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;array<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;private&nbsp;</span><span style="color: #0000CC">$timers&nbsp;</span><span style="color: #006600">=&nbsp;array();<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Number&nbsp;of&nbsp;active&nbsp;connection&nbsp;handler&nbsp;processes<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;</span><span style="color: #0000CC">$nb_forked_processes&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">0</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;active&nbsp;children&nbsp;before&nbsp;incoming&nbsp;connections&nbsp;get&nbsp;delayed<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;</span><span style="color: #0000CC">$max_forked_processes&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">64</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Are&nbsp;we&nbsp;master&nbsp;or&nbsp;child&nbsp;process&nbsp;?<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;</span><span style="color: #0000CC">$child_process&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Forked&nbsp;server&nbsp;handled&nbsp;connection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;NS_Connection_Handler<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;private&nbsp;</span><span style="color: #0000CC">$forked_connection</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Forked&nbsp;server&nbsp;pipe&nbsp;to&nbsp;the&nbsp;master&nbsp;process<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;NS_Socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;</span><span style="color: #0000CC">$master_pipe</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Class&nbsp;Nanoserv&nbsp;should&nbsp;not&nbsp;be&nbsp;instanciated&nbsp;but&nbsp;used&nbsp;statically<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">private&nbsp;function&nbsp;</span><span style="color: #0000CC">__construct</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Register&nbsp;a&nbsp;new&nbsp;listener<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;For&nbsp;consistency&nbsp;New_Listener()&nbsp;will&nbsp;also&nbsp;wrap&nbsp;Nanoserv::New_Datagram_Handler()&nbsp;if&nbsp;the&nbsp;given&nbsp;addr&nbsp;is&nbsp;of&nbsp;type&nbsp;"udp"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$addr<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$handler_classname<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mixed&nbsp;$handler_options<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;NS_Listener<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;NS_Listener<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;NS_Datagram_Handler<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">New_Listener</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$handler_classname</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$handler_options</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">strtolower</span><span style="color: #006600">(</span><span style="color: #0000CC">strtok</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">,&nbsp;</span><span style="color: #CC0000">":"</span><span style="color: #006600">))&nbsp;==&nbsp;</span><span style="color: #CC0000">"udp"</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$l&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">New_Datagram_Handler</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$handler_classname</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$l&nbsp;</span><span style="color: #006600">=&nbsp;new&nbsp;</span><span style="color: #0000CC">NS_Listener</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$handler_classname</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$handler_options</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$listeners</span><span style="color: #006600">[]&nbsp;=&nbsp;</span><span style="color: #0000CC">$l</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$l</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Deactivate&nbsp;and&nbsp;free&nbsp;a&nbsp;previously&nbsp;registered&nbsp;listener<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;For&nbsp;consistency&nbsp;Free_Listener()&nbsp;will&nbsp;also&nbsp;wrap&nbsp;Nanoserv::Free_Datagram_Handler()&nbsp;if&nbsp;the&nbsp;given&nbsp;object&nbsp;is&nbsp;an&nbsp;instance&nbsp;of&nbsp;NS_Datagram_Handler<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;NS_Listener&nbsp;$l<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;NS_Listener<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;NS_Datagram_Handler<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">Free_Listener</span><span style="color: #006600">(</span><span style="color: #0000CC">$l</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$l&nbsp;</span><span style="color: #006600">instanceof&nbsp;</span><span style="color: #0000CC">NS_Listener</span><span style="color: #006600">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$listeners&nbsp;</span><span style="color: #006600">as&nbsp;</span><span style="color: #0000CC">$k&nbsp;</span><span style="color: #006600">=&gt;&nbsp;</span><span style="color: #0000CC">$v</span><span style="color: #006600">)&nbsp;if&nbsp;(</span><span style="color: #0000CC">$v&nbsp;</span><span style="color: #006600">===&nbsp;</span><span style="color: #0000CC">$l</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$listeners</span><span style="color: #006600">[</span><span style="color: #0000CC">$k</span><span style="color: #006600">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(</span><span style="color: #0000CC">$l&nbsp;</span><span style="color: #006600">instanceof&nbsp;</span><span style="color: #0000CC">NS_Datagram_Handler</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">Free_Datagram_Handler</span><span style="color: #006600">(</span><span style="color: #0000CC">$l</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Register&nbsp;a&nbsp;new&nbsp;write&nbsp;buffer<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;method&nbsp;is&nbsp;used&nbsp;by&nbsp;NS_Connection_Handler::Write()&nbsp;and&nbsp;should&nbsp;not&nbsp;be&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;called&nbsp;unless&nbsp;you&nbsp;really&nbsp;know&nbsp;what&nbsp;you&nbsp;are&nbsp;doing<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;NS_Socket&nbsp;$socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$data<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mixed&nbsp;$callback<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;NS_Write_Buffer<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;NS_Connection_Handler::Write()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">New_Write_Buffer</span><span style="color: #006600">(</span><span style="color: #0000CC">NS_Socket&nbsp;$socket</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$data</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$callback</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">strlen</span><span style="color: #006600">(</span><span style="color: #0000CC">$data</span><span style="color: #006600">)&nbsp;==&nbsp;</span><span style="color: #0000CC">0</span><span style="color: #006600">)&nbsp;return&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$wb&nbsp;</span><span style="color: #006600">=&nbsp;new&nbsp;</span><span style="color: #0000CC">NS_Write_Buffer</span><span style="color: #006600">(</span><span style="color: #0000CC">$socket</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$data</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$callback</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$write_buffers</span><span style="color: #006600">[</span><span style="color: #0000CC">$socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">id</span><span style="color: #006600">][]&nbsp;=&nbsp;</span><span style="color: #0000CC">$wb</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$wb</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Free&nbsp;a&nbsp;registered&nbsp;write&nbsp;buffer<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$sid&nbsp;socket&nbsp;id<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">Free_Write_Buffers</span><span style="color: #006600">(</span><span style="color: #0000CC">$sid</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$write_buffers</span><span style="color: #006600">[</span><span style="color: #0000CC">$sid</span><span style="color: #006600">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Register&nbsp;a&nbsp;new&nbsp;outgoing&nbsp;connection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$addr<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$handler_classname<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mixed&nbsp;$handler_options<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;NS_Connection_Handler<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;NS_Connection_Handler<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">New_Connection</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$handler_classname</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$handler_options</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$sck&nbsp;</span><span style="color: #006600">=&nbsp;new&nbsp;</span><span style="color: #0000CC">NS_Client_Socket</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$h&nbsp;</span><span style="color: #006600">=&nbsp;new&nbsp;</span><span style="color: #0000CC">$handler_classname</span><span style="color: #006600">(</span><span style="color: #0000CC">$handler_options</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$h</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$sck</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$connections</span><span style="color: #006600">[</span><span style="color: #0000CC">$sck</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">id</span><span style="color: #006600">]&nbsp;=&nbsp;</span><span style="color: #0000CC">$h</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$h</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Free&nbsp;an&nbsp;allocated&nbsp;connection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;NS_Connection_Handler&nbsp;$h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">Free_Connection</span><span style="color: #006600">(</span><span style="color: #0000CC">NS_Connection_Handler&nbsp;$h</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$connections</span><span style="color: #006600">[</span><span style="color: #0000CC">$h</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">id</span><span style="color: #006600">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">Free_Write_Buffers</span><span style="color: #006600">(</span><span style="color: #0000CC">$h</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">id</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$h</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">pending_connect&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$h</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">pending_crypto&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$child_process&nbsp;</span><span style="color: #006600">&amp;&amp;&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$forked_connection&nbsp;</span><span style="color: #006600">===&nbsp;</span><span style="color: #0000CC">$h</span><span style="color: #006600">))&nbsp;exit();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Register&nbsp;a&nbsp;new&nbsp;datagram&nbsp;(udp)&nbsp;handler<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$addr<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$handler_classname<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;NS_Datagram_Handler<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;NS_Datagram_Handler<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9.61<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">New_Datagram_Handler</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$handler_classname</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$h&nbsp;</span><span style="color: #006600">=&nbsp;new&nbsp;</span><span style="color: #0000CC">$handler_classname</span><span style="color: #006600">(</span><span style="color: #0000CC">$addr</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$dgram_handlers</span><span style="color: #006600">[</span><span style="color: #0000CC">$h</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">id</span><span style="color: #006600">]&nbsp;=&nbsp;</span><span style="color: #0000CC">$h</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$h</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Deactivate&nbsp;and&nbsp;free&nbsp;a&nbsp;datagram&nbsp;handler<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;NS_Datagram_Handler&nbsp;$h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;bool<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9.61<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">Free_Datagram_Handler</span><span style="color: #006600">(</span><span style="color: #0000CC">NS_Datagram_Handler&nbsp;$h</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$dgram_handlers</span><span style="color: #006600">[</span><span style="color: #0000CC">$h</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">id</span><span style="color: #006600">]);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Register&nbsp;a&nbsp;new&nbsp;shared&nbsp;object<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;shared&nbsp;objects&nbsp;allow&nbsp;forked&nbsp;processes&nbsp;to&nbsp;use&nbsp;objects&nbsp;stored&nbsp;on&nbsp;the&nbsp;master&nbsp;process<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;if&nbsp;$o&nbsp;is&nbsp;ommited,&nbsp;a&nbsp;new&nbsp;StdClass&nbsp;empty&nbsp;object&nbsp;is&nbsp;created<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;object&nbsp;$o<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;NS_Shared_Object<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">New_Shared_Object</span><span style="color: #006600">(</span><span style="color: #0000CC">$o&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$shr&nbsp;</span><span style="color: #006600">=&nbsp;new&nbsp;</span><span style="color: #0000CC">NS_Shared_Object</span><span style="color: #006600">(</span><span style="color: #0000CC">$o</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$shared_objects</span><span style="color: #006600">[</span><span style="color: #0000CC">$shr</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">_oid</span><span style="color: #006600">]&nbsp;=&nbsp;</span><span style="color: #0000CC">$shr</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$shr</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Free&nbsp;a&nbsp;shared&nbsp;object<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;NS_Shared_Object&nbsp;$o<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">Free_Shared_Object</span><span style="color: #006600">(</span><span style="color: #0000CC">NS_Shared_Object&nbsp;$o</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$shared_objects</span><span style="color: #006600">[</span><span style="color: #0000CC">$o</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">_oid</span><span style="color: #006600">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Register&nbsp;a&nbsp;new&nbsp;timer&nbsp;callback<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$delay&nbsp;specified&nbsp;in&nbsp;seconds<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mixed&nbsp;$callback&nbsp;may&nbsp;be&nbsp;"function"&nbsp;or&nbsp;array($obj,&nbsp;"method")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;NS_Timer<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">New_Timer</span><span style="color: #006600">(</span><span style="color: #0000CC">$delay</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$callback</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$time_t&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">time</span><span style="color: #006600">()&nbsp;+&nbsp;</span><span style="color: #0000CC">$delay</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$t&nbsp;</span><span style="color: #006600">=&nbsp;new&nbsp;</span><span style="color: #0000CC">NS_Timer</span><span style="color: #006600">(</span><span style="color: #0000CC">$time_t</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$callback</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$timers</span><span style="color: #006600">[</span><span style="color: #0000CC">$time_t</span><span style="color: #006600">][]&nbsp;=&nbsp;</span><span style="color: #0000CC">$t</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">ksort</span><span style="color: #006600">(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$timers</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$t</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Clear&nbsp;all&nbsp;existing&nbsp;timers<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;int&nbsp;number&nbsp;of&nbsp;timers&nbsp;cleared<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;2.0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">Clear_Timers</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$ret&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">count</span><span style="color: #006600">(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$timers</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$timers&nbsp;</span><span style="color: #006600">=&nbsp;array();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$ret</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;all&nbsp;registered&nbsp;NS_Connection_Handler&nbsp;objects<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Note:&nbsp;connections&nbsp;created&nbsp;by&nbsp;fork()ing&nbsp;listeners&nbsp;can&nbsp;not&nbsp;be&nbsp;retreived&nbsp;this&nbsp;way<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;bool&nbsp;$include_pending_connect<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">Get_Connections</span><span style="color: #006600">(</span><span style="color: #0000CC">$include_pending_connect</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$ret&nbsp;</span><span style="color: #006600">=&nbsp;array();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$connections&nbsp;</span><span style="color: #006600">as&nbsp;</span><span style="color: #0000CC">$c</span><span style="color: #006600">)&nbsp;if&nbsp;(</span><span style="color: #0000CC">$c</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">connected&nbsp;</span><span style="color: #006600">||&nbsp;</span><span style="color: #0000CC">$include_pending_connect</span><span style="color: #006600">)&nbsp;</span><span style="color: #0000CC">$ret</span><span style="color: #006600">[]&nbsp;=&nbsp;</span><span style="color: #0000CC">$c</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$ret</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;all&nbsp;registered&nbsp;NS_Listener&nbsp;objects<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;bool&nbsp;$include_inactive<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">Get_Listeners</span><span style="color: #006600">(</span><span style="color: #0000CC">$include_inactive</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$ret&nbsp;</span><span style="color: #006600">=&nbsp;array();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$listeners&nbsp;</span><span style="color: #006600">as&nbsp;</span><span style="color: #0000CC">$l</span><span style="color: #006600">)&nbsp;if&nbsp;(</span><span style="color: #0000CC">$l</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">active&nbsp;</span><span style="color: #006600">||&nbsp;</span><span style="color: #0000CC">$include_inactive</span><span style="color: #006600">)&nbsp;</span><span style="color: #0000CC">$ret</span><span style="color: #006600">[]&nbsp;=&nbsp;</span><span style="color: #0000CC">$l</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$ret</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Set&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;allowed&nbsp;children&nbsp;processes&nbsp;before&nbsp;delaying&nbsp;incoming&nbsp;connections<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Note:&nbsp;this&nbsp;setting&nbsp;only&nbsp;affect&nbsp;and&nbsp;applies&nbsp;to&nbsp;forking&nbsp;listeners<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$i<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;2.0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">Set_Max_Children</span><span style="color: #006600">(</span><span style="color: #0000CC">$i</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$max_forked_processes&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$i</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Flush&nbsp;all&nbsp;write&nbsp;buffers<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;2.0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">Flush_Write_Buffers</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$write_buffers</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">Run</span><span style="color: #006600">(</span><span style="color: #0000CC">1</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Fork&nbsp;and&nbsp;setup&nbsp;IPC&nbsp;sockets<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;int&nbsp;the&nbsp;pid&nbsp;of&nbsp;the&nbsp;created&nbsp;process,&nbsp;0&nbsp;if&nbsp;child&nbsp;process<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9.63<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">Fork</span><span style="color: #006600">()&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$has_shared&nbsp;</span><span style="color: #006600">=&nbsp;(</span><span style="color: #0000CC">NS_Shared_Object</span><span style="color: #006600">::</span><span style="color: #0000CC">$shared_count&nbsp;</span><span style="color: #006600">&gt;&nbsp;</span><span style="color: #0000CC">0</span><span style="color: #006600">))&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list(</span><span style="color: #0000CC">$s1</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$s2</span><span style="color: #006600">)&nbsp;=&nbsp;</span><span style="color: #0000CC">NS_IPC_Socket</span><span style="color: #006600">::</span><span style="color: #0000CC">Pair</span><span style="color: #006600">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$pid&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">pcntl_fork</span><span style="color: #006600">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$pid&nbsp;</span><span style="color: #006600">===&nbsp;</span><span style="color: #0000CC">0</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$child_process&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$has_shared</span><span style="color: #006600">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$master_pipe&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$s2</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(</span><span style="color: #0000CC">$pid&nbsp;</span><span style="color: #006600">&gt;&nbsp;</span><span style="color: #0000CC">0</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$nb_forked_processes</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$has_shared</span><span style="color: #006600">)&nbsp;{&nbsp;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$s1</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">pid&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$pid</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$forked_pipes</span><span style="color: #006600">[</span><span style="color: #0000CC">$pid</span><span style="color: #006600">]&nbsp;=&nbsp;</span><span style="color: #0000CC">$s1</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$pid</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Enter&nbsp;main&nbsp;loop<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;int&nbsp;$loops&nbsp;if&nbsp;omited&nbsp;nanoserv&nbsp;will&nbsp;enter&nbsp;an&nbsp;endless&nbsp;loop<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;array&nbsp;$user_streams&nbsp;if&nbsp;specified,&nbsp;user&nbsp;streams&nbsp;will&nbsp;be&nbsp;polled&nbsp;along&nbsp;with&nbsp;internal&nbsp;streams<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array&nbsp;the&nbsp;user&nbsp;streams&nbsp;with&nbsp;pending&nbsp;data<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;0.9<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">static&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000CC">Run</span><span style="color: #006600">(</span><span style="color: #0000CC">$loops</span><span style="color: #006600">=</span><span style="color: #0000CC">false</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$user_streams</span><span style="color: #006600">=array())&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$tmp&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">0</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$ret&nbsp;</span><span style="color: #006600">=&nbsp;array();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(</span><span style="color: #0000CC">$loops&nbsp;</span><span style="color: #006600">!==&nbsp;</span><span style="color: #0000CC">0</span><span style="color: #006600">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$t&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">time</span><span style="color: #006600">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">//&nbsp;Timers<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">foreach&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$timers&nbsp;</span><span style="color: #006600">as&nbsp;</span><span style="color: #0000CC">$tmr_t&nbsp;</span><span style="color: #006600">=&gt;&nbsp;</span><span style="color: #0000CC">$tmr_a</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$tmr_t&nbsp;</span><span style="color: #006600">&gt;&nbsp;</span><span style="color: #0000CC">$t</span><span style="color: #006600">)&nbsp;break;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000CC">$tmr_a&nbsp;</span><span style="color: #006600">as&nbsp;</span><span style="color: #0000CC">$tmr</span><span style="color: #006600">)&nbsp;if&nbsp;(</span><span style="color: #0000CC">$tmr</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">active</span><span style="color: #006600">)&nbsp;</span><span style="color: #0000CC">call_user_func</span><span style="color: #006600">(</span><span style="color: #0000CC">$tmr</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">callback</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$timers</span><span style="color: #006600">[</span><span style="color: #0000CC">$tmr_t</span><span style="color: #006600">]);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">//&nbsp;Write&nbsp;buffers&nbsp;to&nbsp;non&nbsp;blocked&nbsp;sockets<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">foreach&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$write_buffers&nbsp;</span><span style="color: #006600">as&nbsp;</span><span style="color: #0000CC">$write_buffers</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #0000CC">$write_buffers&nbsp;</span><span style="color: #006600">||&nbsp;</span><span style="color: #0000CC">$write_buffers</span><span style="color: #006600">[</span><span style="color: #0000CC">0</span><span style="color: #006600">]-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">blocked&nbsp;</span><span style="color: #006600">||&nbsp;!</span><span style="color: #0000CC">$write_buffers</span><span style="color: #006600">[</span><span style="color: #0000CC">0</span><span style="color: #006600">]-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">connected</span><span style="color: #006600">)&nbsp;continue;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000CC">$write_buffers&nbsp;</span><span style="color: #006600">as&nbsp;</span><span style="color: #0000CC">$wb</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(</span><span style="color: #0000CC">$wb</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Waiting_Data</span><span style="color: #006600">()&nbsp;&amp;&amp;&nbsp;!</span><span style="color: #0000CC">$wb</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">blocked</span><span style="color: #006600">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$wb</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Write</span><span style="color: #006600">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #0000CC">$wb</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Waiting_Data</span><span style="color: #006600">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">array_shift</span><span style="color: #006600">(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$write_buffers</span><span style="color: #006600">[</span><span style="color: #0000CC">$wb</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">id</span><span style="color: #006600">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$write_buffers</span><span style="color: #006600">[</span><span style="color: #0000CC">$wb</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">id</span><span style="color: #006600">])&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">Free_Write_Buffers</span><span style="color: #006600">(</span><span style="color: #0000CC">$wb</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">id</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset(</span><span style="color: #0000CC">$handler</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$write_buffers</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$l</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$c</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$wbs</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$wb</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$data</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">//&nbsp;Prepare&nbsp;socket&nbsp;arrays<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$fd_lookup_r&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$fd_lookup_w&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$rfd&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$wfd&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$efd&nbsp;</span><span style="color: #006600">=&nbsp;array();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$listeners&nbsp;</span><span style="color: #006600">as&nbsp;</span><span style="color: #0000CC">$l</span><span style="color: #006600">)&nbsp;if&nbsp;((</span><span style="color: #0000CC">$l</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">active</span><span style="color: #006600">)&nbsp;&amp;&amp;&nbsp;((!</span><span style="color: #0000CC">$l</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">forking</span><span style="color: #006600">)&nbsp;||&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$nb_forked_processes&nbsp;</span><span style="color: #006600">&lt;=&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$max_forked_processes</span><span style="color: #006600">)))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$rfd</span><span style="color: #006600">[]&nbsp;=&nbsp;</span><span style="color: #0000CC">$l</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$fd_lookup_r</span><span style="color: #006600">[(int)</span><span style="color: #0000CC">$l</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">]&nbsp;=&nbsp;</span><span style="color: #0000CC">$l</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$connections&nbsp;</span><span style="color: #006600">as&nbsp;</span><span style="color: #0000CC">$c</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$c</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">pending_crypto&nbsp;</span><span style="color: #006600">&amp;&amp;&nbsp;</span><span style="color: #0000CC">$c</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Enable_Crypto</span><span style="color: #006600">())&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$c</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">on_Accept</span><span style="color: #006600">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(</span><span style="color: #0000CC">$c</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">connected</span><span style="color: #006600">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$rfd</span><span style="color: #006600">[]&nbsp;=&nbsp;</span><span style="color: #0000CC">$c</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$fd_lookup_r</span><span style="color: #006600">[(int)</span><span style="color: #0000CC">$c</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">]&nbsp;=&nbsp;</span><span style="color: #0000CC">$c</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(</span><span style="color: #0000CC">$c</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">connect_timeout&nbsp;</span><span style="color: #006600">&lt;&nbsp;</span><span style="color: #0000CC">$t</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$c</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">on_Connect_Fail</span><span style="color: #006600">(</span><span style="color: #0000CC">NS_Connection_Handler</span><span style="color: #006600">::</span><span style="color: #0000CC">FAIL_TIMEOUT</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">Free_Connection</span><span style="color: #006600">(</span><span style="color: #0000CC">$c</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(</span><span style="color: #0000CC">$c</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">pending_connect</span><span style="color: #006600">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$wfd</span><span style="color: #006600">[]&nbsp;=&nbsp;</span><span style="color: #0000CC">$c</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$fd_lookup_w</span><span style="color: #006600">[(int)</span><span style="color: #0000CC">$c</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">]&nbsp;=&nbsp;</span><span style="color: #0000CC">$c</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$dgram_handlers&nbsp;</span><span style="color: #006600">as&nbsp;</span><span style="color: #0000CC">$l</span><span style="color: #006600">)&nbsp;if&nbsp;(</span><span style="color: #0000CC">$l</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">active</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$rfd</span><span style="color: #006600">[]&nbsp;=&nbsp;</span><span style="color: #0000CC">$l</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$fd_lookup_r</span><span style="color: #006600">[(int)</span><span style="color: #0000CC">$l</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">]&nbsp;=&nbsp;</span><span style="color: #0000CC">$l</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$write_buffers&nbsp;</span><span style="color: #006600">as&nbsp;</span><span style="color: #0000CC">$wbs</span><span style="color: #006600">)&nbsp;if&nbsp;(</span><span style="color: #0000CC">$wbs</span><span style="color: #006600">[</span><span style="color: #0000CC">0</span><span style="color: #006600">]-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">blocked</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$wfd</span><span style="color: #006600">[]&nbsp;=&nbsp;</span><span style="color: #0000CC">$wbs</span><span style="color: #006600">[</span><span style="color: #0000CC">0</span><span style="color: #006600">]-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$fd_lookup_w</span><span style="color: #006600">[(int)</span><span style="color: #0000CC">$wbs</span><span style="color: #006600">[</span><span style="color: #0000CC">0</span><span style="color: #006600">]-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">]&nbsp;=&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$connections</span><span style="color: #006600">[</span><span style="color: #0000CC">$wbs</span><span style="color: #006600">[</span><span style="color: #0000CC">0</span><span style="color: #006600">]-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">id</span><span style="color: #006600">];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$forked_pipes&nbsp;</span><span style="color: #006600">as&nbsp;</span><span style="color: #0000CC">$fp</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$rfd</span><span style="color: #006600">[]&nbsp;=&nbsp;</span><span style="color: #0000CC">$fp</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$fd_lookup_r</span><span style="color: #006600">[(int)</span><span style="color: #0000CC">$fp</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">fd</span><span style="color: #006600">]&nbsp;=&nbsp;</span><span style="color: #0000CC">$fp</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$user_streams</span><span style="color: #006600">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;((array)</span><span style="color: #0000CC">$user_streams</span><span style="color: #006600">[</span><span style="color: #0000CC">0</span><span style="color: #006600">]&nbsp;as&nbsp;</span><span style="color: #0000CC">$tmp_r</span><span style="color: #006600">)&nbsp;</span><span style="color: #0000CC">$rfd</span><span style="color: #006600">[]&nbsp;=&nbsp;</span><span style="color: #0000CC">$tmp_r</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;((array)</span><span style="color: #0000CC">$user_streams</span><span style="color: #006600">[</span><span style="color: #0000CC">1</span><span style="color: #006600">]&nbsp;as&nbsp;</span><span style="color: #0000CC">$tmp_w</span><span style="color: #006600">)&nbsp;</span><span style="color: #0000CC">$wfd</span><span style="color: #006600">[]&nbsp;=&nbsp;</span><span style="color: #0000CC">$tmp_w</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">//&nbsp;Main&nbsp;select<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">if&nbsp;((</span><span style="color: #0000CC">$rfd&nbsp;</span><span style="color: #006600">||&nbsp;</span><span style="color: #0000CC">$wfd</span><span style="color: #006600">)&nbsp;&amp;&amp;&nbsp;(@</span><span style="color: #0000CC">stream_select</span><span style="color: #006600">(</span><span style="color: #0000CC">$rfd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$wfd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$efd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">1</span><span style="color: #006600">)))&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000CC">$rfd&nbsp;</span><span style="color: #006600">as&nbsp;</span><span style="color: #0000CC">$act_rfd</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$fd_lookup_r</span><span style="color: #006600">[(int)</span><span style="color: #0000CC">$act_rfd</span><span style="color: #006600">];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isset(</span><span style="color: #0000CC">$handler</span><span style="color: #006600">))&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">//&nbsp;User&nbsp;stream<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$ret</span><span style="color: #006600">[</span><span style="color: #0000CC">0</span><span style="color: #006600">][]&nbsp;=&nbsp;</span><span style="color: #0000CC">$act_rfd</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(</span><span style="color: #0000CC">$handler&nbsp;</span><span style="color: #006600">instanceof&nbsp;</span><span style="color: #0000CC">NS_Connection_Handler</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">connected</span><span style="color: #006600">)&nbsp;continue;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$data&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Read</span><span style="color: #006600">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">strlen</span><span style="color: #006600">(</span><span style="color: #0000CC">$data</span><span style="color: #006600">)&nbsp;===&nbsp;</span><span style="color: #0000CC">0</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Eof</span><span style="color: #006600">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">//&nbsp;Disconnected&nbsp;socket<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">connected&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">on_Disconnect</span><span style="color: #006600">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">Free_Connection</span><span style="color: #006600">(</span><span style="color: #0000CC">$handler</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">//&nbsp;Data&nbsp;available<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">on_Read</span><span style="color: #006600">(</span><span style="color: #0000CC">$data</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(</span><span style="color: #0000CC">$handler&nbsp;</span><span style="color: #006600">instanceof&nbsp;</span><span style="color: #0000CC">NS_Datagram_Handler</span><span style="color: #006600">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$from&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #CC0000">""</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$data&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Read_From</span><span style="color: #006600">(</span><span style="color: #0000CC">$from</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">on_Read</span><span style="color: #006600">(</span><span style="color: #0000CC">$from</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$data</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(</span><span style="color: #0000CC">$handler&nbsp;</span><span style="color: #006600">instanceof&nbsp;</span><span style="color: #0000CC">NS_Listener</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(</span><span style="color: #0000CC">$fd&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Accept</span><span style="color: #006600">())&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">//&nbsp;New&nbsp;connection&nbsp;accepted<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$sck&nbsp;</span><span style="color: #006600">=&nbsp;new&nbsp;</span><span style="color: #0000CC">NS_Socket</span><span style="color: #006600">(</span><span style="color: #0000CC">$fd</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">crypto_type</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$hnd&nbsp;</span><span style="color: #006600">=&nbsp;new&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">handler_classname</span><span style="color: #006600">(</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">handler_options</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$hnd</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$sck</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">forking</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$hnd</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">on_Fork_Prepare</span><span style="color: #006600">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">Fork</span><span style="color: #006600">()&nbsp;===&nbsp;</span><span style="color: #0000CC">0</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$hnd</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">on_Fork_Done</span><span style="color: #006600">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$write_buffers&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$listeners&nbsp;</span><span style="color: #006600">=&nbsp;array();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$connections&nbsp;</span><span style="color: #006600">=&nbsp;array(</span><span style="color: #0000CC">$sck</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">id&nbsp;</span><span style="color: #006600">=&gt;&nbsp;</span><span style="color: #0000CC">$hnd</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$forked_connection&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$hnd</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">Clear_Timers</span><span style="color: #006600">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$sck</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Setup</span><span style="color: #006600">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$hnd</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">on_Accept</span><span style="color: #006600">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$hnd&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$sck&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$l&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$c&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$wbs&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$wb&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$fd_lookup_r&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$fd_lookup_w&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$loops&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$hnd</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">on_Fork_Done</span><span style="color: #006600">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$nb_forked_processes&nbsp;</span><span style="color: #006600">&gt;=&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$max_forked_processes</span><span style="color: #006600">)&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$connections</span><span style="color: #006600">[</span><span style="color: #0000CC">$sck</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">id</span><span style="color: #006600">]&nbsp;=&nbsp;</span><span style="color: #0000CC">$hnd</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$sck</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Setup</span><span style="color: #006600">())&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$hnd</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">on_Accept</span><span style="color: #006600">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset(</span><span style="color: #0000CC">$sck</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$hnd</span><span style="color: #006600">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(</span><span style="color: #0000CC">$handler&nbsp;</span><span style="color: #006600">instanceof&nbsp;</span><span style="color: #0000CC">NS_IPC_Socket</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(</span><span style="color: #0000CC">$ipcm&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Read</span><span style="color: #006600">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((!</span><span style="color: #0000CC">$ipcq&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">unserialize</span><span style="color: #006600">(</span><span style="color: #0000CC">$ipcm</span><span style="color: #006600">))&nbsp;||&nbsp;(!</span><span style="color: #0000CC">is_object</span><span style="color: #006600">(</span><span style="color: #0000CC">$o&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$shared_objects</span><span style="color: #006600">[</span><span style="color: #0000CC">$ipcq</span><span style="color: #006600">[</span><span style="color: #CC0000">"oid"</span><span style="color: #006600">]])))&nbsp;continue;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">NS_Shared_Object</span><span style="color: #006600">::</span><span style="color: #0000CC">$caller_pid&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">pid</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(</span><span style="color: #0000CC">$ipcq</span><span style="color: #006600">[</span><span style="color: #CC0000">"action"</span><span style="color: #006600">])&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #CC0000">"G"</span><span style="color: #006600">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Write</span><span style="color: #006600">(</span><span style="color: #0000CC">serialize</span><span style="color: #006600">(</span><span style="color: #0000CC">$o</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">$ipcq</span><span style="color: #006600">[</span><span style="color: #CC0000">"var"</span><span style="color: #006600">]));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #CC0000">"S"</span><span style="color: #006600">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$o</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">$ipcq</span><span style="color: #006600">[</span><span style="color: #CC0000">"var"</span><span style="color: #006600">]&nbsp;=&nbsp;</span><span style="color: #0000CC">$ipcq</span><span style="color: #006600">[</span><span style="color: #CC0000">"val"</span><span style="color: #006600">];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #CC0000">"C"</span><span style="color: #006600">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Write</span><span style="color: #006600">(</span><span style="color: #0000CC">serialize</span><span style="color: #006600">(</span><span style="color: #0000CC">call_user_func_array</span><span style="color: #006600">(array(</span><span style="color: #0000CC">$o</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$ipcq</span><span style="color: #006600">[</span><span style="color: #CC0000">"func"</span><span style="color: #006600">]),&nbsp;</span><span style="color: #0000CC">$ipcq</span><span style="color: #006600">[</span><span style="color: #CC0000">"args"</span><span style="color: #006600">])));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset(</span><span style="color: #0000CC">$o</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$ipcq</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">$ipcm</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000CC">$wfd&nbsp;</span><span style="color: #006600">as&nbsp;</span><span style="color: #0000CC">$act_wfd</span><span style="color: #006600">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">$fd_lookup_w</span><span style="color: #006600">[</span><span style="color: #0000CC">$act_wfd</span><span style="color: #006600">];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isset(</span><span style="color: #0000CC">$handler</span><span style="color: #006600">))&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">//&nbsp;User&nbsp;stream<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$ret</span><span style="color: #006600">[</span><span style="color: #0000CC">1</span><span style="color: #006600">][]&nbsp;=&nbsp;</span><span style="color: #0000CC">$act_wfd</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">connected</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">//&nbsp;Unblock&nbsp;buffered&nbsp;write<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">if&nbsp;(</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Eof</span><span style="color: #006600">())&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">on_Disconnect</span><span style="color: #006600">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">Free_Connection</span><span style="color: #006600">(</span><span style="color: #0000CC">$handler</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">blocked&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">pending_connect</span><span style="color: #006600">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF9900">//&nbsp;Pending&nbsp;connect<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #006600">if&nbsp;(</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Eof</span><span style="color: #006600">())&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">on_Connect_Fail</span><span style="color: #006600">(</span><span style="color: #0000CC">NS_Connection_Handler</span><span style="color: #006600">::</span><span style="color: #0000CC">FAIL_NORESPONSE</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">Free_Connection</span><span style="color: #006600">(</span><span style="color: #0000CC">$handler</span><span style="color: #006600">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">Setup</span><span style="color: #006600">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">connected&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">true</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">socket</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">pending_connect&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000CC">$handler</span><span style="color: #006600">-&gt;</span><span style="color: #0000CC">on_Connect</span><span style="color: #006600">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$nb_forked_processes&nbsp;</span><span style="color: #006600">&amp;&amp;&nbsp;!</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$child_process</span><span style="color: #006600">)&nbsp;while&nbsp;(((</span><span style="color: #0000CC">$pid&nbsp;</span><span style="color: #006600">=&nbsp;</span><span style="color: #0000CC">pcntl_wait</span><span style="color: #006600">(</span><span style="color: #0000CC">$tmp</span><span style="color: #006600">,&nbsp;</span><span style="color: #0000CC">WNOHANG</span><span style="color: #006600">))&nbsp;&gt;&nbsp;</span><span style="color: #0000CC">0</span><span style="color: #006600">)&nbsp;&amp;&amp;&nbsp;</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$nb_forked_processes</span><span style="color: #006600">--)&nbsp;unset(</span><span style="color: #0000CC">self</span><span style="color: #006600">::</span><span style="color: #0000CC">$forked_pipes</span><span style="color: #006600">[</span><span style="color: #0000CC">$pid</span><span style="color: #006600">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$loops&nbsp;</span><span style="color: #006600">!==&nbsp;</span><span style="color: #0000CC">false</span><span style="color: #006600">)&nbsp;--</span><span style="color: #0000CC">$loops</span><span style="color: #006600">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000CC">$ret</span><span style="color: #006600">)&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000CC">$ret</span><span style="color: #006600">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /><br /></span><span style="color: #0000CC">?&gt;<br /></span>
</span>
</code>